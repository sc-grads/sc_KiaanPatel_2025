name: Setup Database and Tables

on:
  push:
    branches:
      - main

jobs:
  setup:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install Microsoft SQL Server Command Line Tools
        run: |
          $toolsUrl = "https://go.microsoft.com/fwlink/?linkid=2156308" # Latest SQL Server ODBC Driver and Command Line Tools
          $installerPath = "$env:TEMP\sqlcmd_installer.exe"
          Invoke-WebRequest -Uri $toolsUrl -OutFile $installerPath
          Start-Process -FilePath $installerPath -ArgumentList "/quiet", "/norestart" -Wait
          # Add sqlcmd to PATH
          echo "C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\170\Tools\Binn" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Test SQL Server Connection
        run: |
          sqlcmd -S "${{ secrets.PINGGY_TCP_TUNNEL }}" -U "${{ secrets.SQL_USERNAME }}" -P "${{ secrets.SQL_PASSWORD }}" -Q "SELECT @@VERSION" -o connection_test.log
          type connection_test.log
        continue-on-error: true

      - name: Run Database Setup Script
        run: sqlcmd -S "${{ secrets.PINGGY_TCP_TUNNEL }}" -U "${{ secrets.SQL_USERNAME }}" -P "${{ secrets.SQL_PASSWORD }}" -i HandsOnProject/Timesheet/TableAndDBSetup.sql
