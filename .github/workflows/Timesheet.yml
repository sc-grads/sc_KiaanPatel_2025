name: Setup Database and Tables

on:
  workflow_dispatch

jobs:
  setup:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install mssql-tools
        run: |
          choco install mssql-server -y
          choco install mssql-cli -y
          # Ensure sqlcmd is in PATH
          echo "C:\Program Files\Microsoft SQL Server\Client SDK\ODBC\170\Tools\Binn" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append

      - name: Test SQL Server Connection
        run: |
          sqlcmd -S "${{ secrets.PINGGY_TCP_TUNNEL }}" -U "${{ secrets.SQL_USERNAME }}" -P "${{ secrets.SQL_PASSWORD }}" -Q "SELECT @@VERSION" -o connection_test.log
          type connection_test.log
        continue-on-error: true

      - name: Run Database Setup Script
        run: sqlcmd -S "${{ secrets.PINGGY_TCP_TUNNEL }}" -U "${{ secrets.SQL_USERNAME }}" -P "${{ secrets.SQL_PASSWORD }}" -i HandsOnProject/Timesheet/TableAndDBSetup.sql
