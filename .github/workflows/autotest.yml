name: AutoTest Database Setup

on:
  push:
    branches:
      - main

jobs:
  setup-database:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Install SQL Server tools
      run: |
        sudo apt-get update
        sudo apt-get install -y curl apt-transport-https gnupg
        curl -sSL https://packages.microsoft.com/keys/microsoft.asc | sudo tee /etc/apt/trusted.gpg.d/microsoft.asc
        sudo add-apt-repository "$(curl -sSL https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/prod.list)"
        sudo apt-get update
        sudo apt-get install -y mssql-tools unixodbc-dev
        echo 'export PATH="$PATH:/opt/mssql-tools/bin"' >> ~/.bashrc
        source ~/.bashrc

    - name: Connect to SQL Server and create database
      run: |
        # Replace 'nice-horses-deny.loca.lt' with your LocalTunnel URL
        sqlcmd -S nice-horses-deny.loca.lt,1433 -U Auto_user -P Password123 -Q "CREATE DATABASE AutoTest;"
        sqlcmd -S nice-horses-deny.loca.lt,1433 -U Auto_user -P Password123 -d AutoTest -Q "CREATE TABLE [user] (Name NVARCHAR(255), Surname NVARCHAR(255), Email NVARCHAR(255));"
        sqlcmd -S nice-horses-deny.loca.lt,1433 -U Auto_user -P Password123 -d AutoTest -Q "EXEC InsertUser @Name='John', @Surname='Doe', @Email='john.doe@example.com';"

    - name: Verify connection (optional)
      run: |
        sqlcmd -S nice-horses-deny.loca.lt,1433 -U Auto_user -P Password123 -d AutoTest -Q "SELECT * FROM [user];"

